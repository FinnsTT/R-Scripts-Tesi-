# ROYLE-NICHOLS DATA PREPARATION (3-day occasions)
 
# Purpose: Prepare detection/non-detection matrix and covariates for RN models
# Output: unmarkedFrameOccu object ready for model fitting

library(unmarked)
library(dplyr)
library(ggplot2)
library(viridis)

setwd("C:/Users/Dell/Desktop/codici tesi/file GIS")

# Load data
count_matrix <- read.csv("count_matrix_3day.csv", stringsAsFactors = FALSE)
site_cov <- read.csv("camera_traps_covariates_POINT.csv", stringsAsFactors = FALSE)
effort_matrix <- read.csv("obs_covariate_effort_3day.csv", stringsAsFactors = FALSE)
human_matrix <- read.csv("obs_covariate_human_3day.csv", stringsAsFactors = FALSE)
competitor_matrix <- read.csv("obs_covariate_competitor_3day.csv", stringsAsFactors = FALSE)
occasion_info <- read.csv("occasion_info_3day.csv", stringsAsFactors = FALSE)

# Create count matrix
stations <- count_matrix$Station
y_counts <- as.matrix(count_matrix[, -1])
rownames(y_counts) <- stations

cat("Count matrix:", nrow(y_counts), "×", ncol(y_counts), "\n\n")

# Prepare site covariates
names(site_cov)[1] <- "Station"

siteCovs <- site_cov %>%
  filter(Station %in% stations) %>%
  arrange(match(Station, stations)) %>%
  select(Station, elevation, tri, tpi,
         dist_water_points, dist_fish_river, dist_konkiep_river,
         dist_tourist_road, dist_staff_buildings,
         Human_Activity, Competitor_Detections)

siteCovs_std <- siteCovs %>% select(-Station) %>% scale() %>% as.data.frame()
siteCovs_original <- siteCovs

# Match occasions
count_cols <- colnames(count_matrix)[-1]
occasion_numbers <- as.numeric(gsub("X", "", count_cols))
cols_to_keep <- c(1, occasion_numbers + 1)

cat("=== MOON DEBUGGING ===\n")
cat("occasion_info structure:\n")
print(str(occasion_info))
cat("\noccasion_info rows:", nrow(occasion_info), "\n")
cat("occasion_numbers:", length(occasion_numbers), "| range:", 
    min(occasion_numbers), "to", max(occasion_numbers), "\n")

# Check if Occasion column exists
if(!"Occasion" %in% names(occasion_info)) {
  cat("Adding Occasion column (1:n)\n")
  occasion_info$Occasion <- 1:nrow(occasion_info)
}

# M1: Direct indexing
cat("\nMethod 1: Direct indexing\n")
moon_vec_direct <- occasion_info$Moon_Illumination[occasion_numbers]
cat("  NAs:", sum(is.na(moon_vec_direct)), "of", length(moon_vec_direct), "\n")

# M 2: Merge 
cat("\nMethod 2: Merge\n")
occasion_mapping <- data.frame(
  Occasion = occasion_numbers,
  Order = 1:length(occasion_numbers)
)

occasion_data <- merge(occasion_mapping, occasion_info, 
                       by = "Occasion", all.x = TRUE, sort = FALSE) %>%
  arrange(Order)

moon_vec_merge <- occasion_data$Moon_Illumination
cat("  NAs:", sum(is.na(moon_vec_merge)), "of", length(moon_vec_merge), "\n")

# best method
if(sum(is.na(moon_vec_direct)) == 0) {
  cat("\n✓ Using direct indexing\n")
  moon_vec <- moon_vec_direct
} else if(sum(is.na(moon_vec_merge)) == 0) {
  cat("\n✓ Using merge method\n")
  moon_vec <- moon_vec_merge
} else {
  cat("\n✗ Both methods have NAs!\n")
  cat("Occasion numbers not in occasion_info:\n")
  missing <- occasion_numbers[!occasion_numbers %in% occasion_info$Occasion]
  print(missing)
  stop("Cannot create valid moon vector")
}

cat("\nMoon values (first 10):", paste(round(head(moon_vec, 10), 3), collapse = ", "), "\n\n")

# Filter observation covariates
effort_mat <- effort_matrix[, cols_to_keep] %>%
  arrange(match(Station, stations)) %>%
  select(-Station) %>%
  as.matrix()

human_mat <- human_matrix[, cols_to_keep] %>%
  arrange(match(Station, stations)) %>%
  select(-Station) %>%
  as.matrix()

competitor_mat <- competitor_matrix[, cols_to_keep] %>%
  arrange(match(Station, stations)) %>%
  select(-Station) %>%
  as.matrix()

# Standardize
effort_std <- scale(effort_mat)
human_std <- scale(human_mat)
competitor_std <- scale(competitor_mat)

# Moon matrix (NON standardizzata - già in 0-1)
moon_mat <- matrix(rep(moon_vec, each = nrow(y_counts)), 
                   nrow = nrow(y_counts), byrow = FALSE)

# Don't scale moon 
moon_std <- moon_mat  # original values (0-1 range)

cat("Moon matrix: ", nrow(moon_mat), "×", ncol(moon_mat), 
    "| NAs:", sum(is.na(moon_std)), 
    "| Range:", round(min(moon_std), 2), "-", round(max(moon_std), 2), "\n")

# Create obsCovs list
obsCovs <- list(
  effort = effort_std,
  moon = moon_std,
  human = human_std,
  competitor = competitor_std
)

# Apply effort mask
y_counts_clean <- y_counts
y_counts_clean[effort_mat == 0] <- NA

# Create unmarked frame
umf <- unmarkedFramePCount(
  y = y_counts_clean,
  siteCovs = siteCovs_std,
  obsCovs = obsCovs
)

cat("\nunmarkedFramePCount created:", numSites(umf), "×", obsNum(umf), "\n")
summary(umf)

# Export
saveRDS(umf, "unmarkedFrame_RN_3day.rds")
write.csv(siteCovs_original, "siteCovs_original_scale.csv", row.names = FALSE)

