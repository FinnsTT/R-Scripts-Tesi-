# ROYLE-NICHOLS DATA PREPARATION (3-day occasions)
 
# Purpose: Prepare detection/non-detection matrix and covariates for RN models
# Output: unmarkedFrameOccu object ready for model fitting

library(unmarked)
library(dplyr)
library(ggplot2)
library(viridis)

setwd("C:/Users/Dell/Desktop/codici tesi/file GIS")

# PART 1: LOAD DATA

# Count matrix (3-day occasions)
count_matrix <- read.csv("count_matrix_3day.csv", stringsAsFactors = FALSE)

# Site covariates
site_cov <- read.csv("camera_traps_covariates_POINT.csv", stringsAsFactors = FALSE)

# Observation covariates
effort_matrix <- read.csv("obs_covariate_effort_3day.csv", stringsAsFactors = FALSE)
human_matrix <- read.csv("obs_covariate_human_3day.csv", stringsAsFactors = FALSE)
competitor_matrix <- read.csv("obs_covariate_competitor_3day.csv", stringsAsFactors = FALSE)
occasion_info <- read.csv("occasion_info_3day.csv", stringsAsFactors = FALSE)

# PART 2: CREATE DETECTION/NON-DETECTION MATRIX (0/1)

stations <- count_matrix$Station
y_counts <- as.matrix(count_matrix[, -1])
rownames(y_counts) <- stations

cat("Count matrix:", nrow(y_counts), "sites ×", ncol(y_counts), "occasions\n")
cat("Total counts:", sum(y_counts, na.rm = TRUE), "\n")
cat("Sites with ≥1 detection:", sum(rowSums(y_counts) > 0), "\n")
cat("Max count:", max(y_counts), "\n\n")

# PART 3: PREPARE SITE COVARIATES

# Rename station column
names(site_cov)[1] <- "Station"

# Select and standardize covariates
siteCovs <- site_cov %>%
  filter(Station %in% stations) %>%
  arrange(match(Station, stations)) %>%
  select(Station, elevation, tri, tpi,
         dist_water_points, dist_fish_river, dist_konkiep_river,
         dist_tourist_road, dist_staff_buildings,
         Human_Activity, Competitor_Detections)

siteCovs_std <- siteCovs %>% select(-Station) %>% scale() %>% as.data.frame()
siteCovs_original <- siteCovs

# PART 4: PREPARE OBSERVATION COVARIATES

# Match occasions between count_matrix and obs_covariates
# count_matrix has occasions corresponding to S10-S21 only
count_cols <- colnames(count_matrix)[-1]
occasion_numbers <- as.numeric(gsub("X", "", count_cols))  # ← QUESTA È LA FIX

cat("Occasion numbers:", length(occasion_numbers), "\n")
cat("Range:", min(occasion_numbers), "to", max(occasion_numbers), "\n\n")

cols_to_keep <- c(1, occasion_numbers + 1)

# Filter and arrange observation covariates
effort_mat <- effort_matrix[, cols_to_keep] %>%
  arrange(match(Station, stations)) %>%
  select(-Station) %>%
  as.matrix()

human_mat <- human_matrix[, cols_to_keep] %>%
  arrange(match(Station, stations)) %>%
  select(-Station) %>%
  as.matrix()

competitor_mat <- competitor_matrix[, cols_to_keep] %>%
  arrange(match(Station, stations)) %>%
  select(-Station) %>%
  as.matrix()

# Standardize observation covariates
effort_std <- scale(effort_mat)
human_std <- scale(human_mat)
competitor_std <- scale(competitor_mat)

# Moon illumination - filter to matching occasions
# occasion_names are the occasion IDs from count_matrix
moon_vec <- occasion_info$Moon_Illumination[occasion_numbers]
moon_mat <- matrix(rep(moon_vec, each = nrow(y_counts)), 
                   nrow = nrow(y_counts), byrow = FALSE)
moon_std <- scale(moon_mat)

# Create list of observation covariates
obsCovs <- list(
  effort = effort_std,
  moon = moon_std,
  human = human_std,
  competitor = competitor_std
)

# PART 5: HANDLE MISSING DATA (effort = 0 → NA)

# Apply effort mask
y_counts_clean <- y_counts
y_counts_clean[effort_mat == 0] <- NA

cat("NA values (effort=0):", sum(is.na(y_counts_clean)), "\n")

# PART 6: CREATE UNMARKEDFRAME

# unmarkedFramePCount for Royle-Nichols (uses counts)
umf <- unmarkedFramePCount(
  y = y_counts_clean,
  siteCovs = siteCovs_std,
  obsCovs = obsCovs
)

cat("\nunmarkedFramePCount created\n")
cat("Sites:", numSites(umf), "\n")
cat("Occasions:", obsNum(umf), "\n")

# PART 7: SUMMARY STATISTICS

summary(umf)

# Naive occupancy (proportion sites with ≥1 detection)
naive_occ <- sum(rowSums(y_counts_clean, na.rm = TRUE) > 0) / nrow(y_counts_clean)
cat("\nNaive occupancy:", round(naive_occ, 3), "\n")

# Mean count per occasion
mean_count <- mean(y_counts_clean, na.rm = TRUE)
cat("Mean count per occasion:", round(mean_count, 3), "\n")

# PART 8: EXPLORATORY PLOTS

# Plot 1: Count frequency over time
count_data <- data.frame(
  Occasion = 1:ncol(y_counts_clean),
  Total_Count = colSums(y_counts_clean, na.rm = TRUE),
  N_Detections = colSums(y_counts_clean > 0, na.rm = TRUE),
  Active_Cameras = colSums(!is.na(y_counts_clean))
)

p1 <- ggplot(count_data, aes(x = Occasion)) +
  geom_line(aes(y = Total_Count, color = "Total Count"), linewidth = 1) +
  geom_line(aes(y = N_Detections, color = "N Detections"), linewidth = 1) +
  scale_color_viridis_d(option = "viridis", name = "") +
  labs(title = "Hyena Counts Over Time (3-day occasions)",
       x = "Occasion", y = "Count") +
  theme_bw()

ggsave("count_frequency_temporal.png", p1, width = 12, height = 5)

# Plot 2: Distribution of counts
count_vec <- as.vector(y_counts_clean)
count_vec <- count_vec[!is.na(count_vec) & count_vec > 0]

p2 <- ggplot(data.frame(Count = count_vec), aes(x = Count)) +
  geom_histogram(binwidth = 1, fill = viridis(1, option = "plasma"), color = "black") +
  labs(title = "Distribution of Non-Zero Counts",
       x = "Count per Occasion", y = "Frequency") +
  theme_bw()

ggsave("count_distribution.png", p2, width = 8, height = 5)

# Plot 3: Counts per station
station_summary <- data.frame(
  Station = stations,
  Total_Count = rowSums(y_counts_clean, na.rm = TRUE),
  N_Detections = rowSums(y_counts_clean > 0, na.rm = TRUE),
  N_Active_Occasions = rowSums(!is.na(y_counts_clean)),
  Mean_Count = rowMeans(y_counts_clean, na.rm = TRUE)
)

p3 <- ggplot(station_summary, aes(x = Total_Count)) +
  geom_histogram(bins = 20, fill = viridis(1, option = "mako"), color = "black") +
  labs(title = "Total Counts per Station",
       x = "Total Count", y = "Frequency") +
  theme_bw()

ggsave("counts_per_station.png", p3, width = 8, height = 5)

# Plot 4: Count vs effort
effort_summary <- data.frame(
  Station = stations,
  Total_Effort = rowSums(effort_mat, na.rm = TRUE),
  Total_Count = rowSums(y_counts_clean, na.rm = TRUE)
)

p4 <- ggplot(effort_summary, aes(x = Total_Effort, y = Total_Count)) +
  geom_point(size = 2, alpha = 0.6, color = viridis(1, option = "rocket")) +
  geom_smooth(method = "lm", se = TRUE, color = viridis(1, option = "plasma"),
              fill = viridis(1, option = "plasma", alpha = 0.3)) +
  labs(title = "Total Count vs Total Effort",
       x = "Total Effort (camera-days)", y = "Total Count") +
  theme_bw()

ggsave("count_vs_effort.png", p4, width = 8, height = 6)

# PART 9: EXPORT

# Save unmarkedFrame
saveRDS(umf, "unmarkedFrame_RN_3day.rds")

# Save original scale covariates for plotting
write.csv(siteCovs_original, "siteCovs_original_scale.csv", row.names = FALSE)

# Save standardization parameters for back-transformation
std_params <- data.frame(
  Variable = names(siteCovs_std),
  Mean = sapply(siteCovs[, names(siteCovs_std)], mean, na.rm = TRUE),
  SD = sapply(siteCovs[, names(siteCovs_std)], sd, na.rm = TRUE)
)
write.csv(std_params, "standardization_parameters.csv", row.names = FALSE)

# Save detection summary
write.csv(station_summary, "station_count_summary.csv", row.names = FALSE)

cat("\nFiles created:\n")
cat("• unmarkedFrame_RN_3day.rds (with COUNTS)\n")
cat("• siteCovs_original_scale.csv\n")
cat("• standardization_parameters.csv\n")
cat("• station_count_summary.csv\n")
cat("• count_frequency_temporal.png\n")
cat("• count_distribution.png\n")
cat("• counts_per_station.png\n")
cat("• count_vs_effort.png\n")
