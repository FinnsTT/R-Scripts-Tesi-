# Install and load packages
install.packages("terra")
install.packages("sf")
install.packages("dplyr")
install.packages("spatialEco")
install.packages("raster")
install.packages("sp")
install.packages("rasterVis")
install.packages("spatstat")

library(terra)
library(sf)
library(dplyr)
library(spatialEco)
library(raster)
library(sp)
library(rasterVis)

# Set working directory
setwd("C:\\Users\\Dell\\Desktop\\codici tesi\\file GIS")

# Load the DEM
dem <- terra::rast('dem.tif')

# Check if loaded correctly
print(dem)
plot(dem, main="Fish River Canyon DEM")

# Load camera trap locations
camera_traps <- terra::vect('camera_traps.shp')

# Check if loaded correctly
print(camera_traps)
plot(dem)
plot(camera_traps, add=TRUE, col='darkgoldenrod1', pch=17, cex=0.5)

# Zoom on the study area
plot(dem, ext=ext(camera_traps)*1.2)  # 20% bigger
plot(camera_traps, add=TRUE, col='darkgoldenrod1', pch=17, cex=1)

# Load all spacial datas
fish_river <- terra::vect('fish_river.shp')
konkiep_river <- terra::vect('konkiep_river.shp')
water_points <- terra::vect('water_points.shp')
tourist_road <- terra::vect('tourist_road.shp')
staff_buildings <- terra::vect('staff_buildings.shp')
study_area <- terra::vect('study_area.shp')

# Check if loded correctly
print(fish_river)
print(konkiep_river)
print(water_points)
print(tourist_road)
print(staff_buildings)
print(study_area)

# Check the extent of each layer
ext(dem)
ext(camera_traps)
ext(fish_river)
ext(konkiep_river)
ext(water_points)
ext(tourist_road)
ext(staff_buildings)
ext(study_area)

# Reproject all geographic layers to match DEM projection
fish_river_utm <- terra::project(fish_river, crs(dem))
konkiep_river_utm <- terra::project(konkiep_river, crs(dem))
water_points_utm <- terra::project(water_points, crs(dem))
tourist_road_utm <- terra::project(tourist_road, crs(dem))
staff_buildings_utm <- terra::project(staff_buildings, crs(dem))

# Check the CRS (coordinate reference system) of each layer
crs(dem)
crs(camera_traps)
crs(fish_river)
crs(konkiep_river)
crs(water_points)
crs(tourist_road)
crs(staff_buildings)
crs(study_area)

# Plot all layers together
plot(dem, main="Spatial data")
plot(dem, ext=ext(camera_traps)*1.2, main="Study Area")
plot(fish_river_utm, add=TRUE, col='mediumpurple3', lwd=3)
plot(konkiep_river_utm, add=TRUE, col='mediumpurple3', lwd=3, lty=2)
plot(water_points_utm, add=TRUE, col='skyblue1', pch=19, cex=1)
plot(tourist_road_utm, add=TRUE, col='red', lwd=1)
plot(staff_buildings_utm, add=TRUE, col='#FFE1FF', pch=15)
plot(camera_traps, add=TRUE, col='#CDBA96', pch=17, cex=1)

# Extract elevation values at camera trap locations
elevation_data <- terra::extract(dem, camera_traps, xy=TRUE) #Takes the DEM raster and extracts the elevation value at each of the 71 camera traps points.

# Check results
head(elevation_data)

# Check column names
print(names(elevation_data))

# rename the elevation column 
names(elevation_data)[2] <- "elevation"

# View the data
head(elevation_data)
str(elevation_data)

# Quick summary statistics
summary(elevation_data$elevation)

# Add elevation values to camera_traps vector
camera_traps$elevation <- elevation_data$elevation

# Add X and Y coordinates
coords <- terra::crds(camera_traps)
camera_traps$X <- coords[, "x"]
camera_traps$Y <- coords[, "y"]

# Check results
print(camera_traps)

# Convert 71 cameras to dataframe and view
camera_traps_df <- as.data.frame(camera_traps)
print(camera_traps_df)
write.csv(camera_traps_df, "camera_traps_with_elevation.csv", row.names=FALSE) # Export to CSV file

#Calculating important terrain variables that affect hyenas habitat

# Calculate SLOPE (degrees)
# Steepness of terrain (important for hyena movement)
slope <- terra::terrain(dem, v='slope', neighbors=8, unit='degrees')
plot(slope, main="Slope (degrees)")

# Calculate TRI (Terrain Ruggedness Index)
# Ridgetop (+) vs valley bottom (-) position
tri <- terra::terrain(dem, v='TRI', neighbors=8)
plot(tri, main="Terrain Ruggedness Index")

# Calculate ASPECT (direction the slope faces)
# Direction slope faces (N,S,E,W-affects sun exposure)
aspect <- terra::terrain(dem, v='aspect', neighbors=8, unit='degrees')
plot(aspect, main="Aspect (degrees)")

# Calculate TPI (Topographic Position Index) - using spatialEco
# Terrain roughness (rough or smooth terrain)
tpi <- spatialEco::tpi(dem, scale=1000, win='circle', normalize=FALSE)
plot(tpi, main="Topographic Position Index")
plot(camera_traps, add=TRUE, col='deeppink3', pch=17, cex=0.5)

#Extract Terrain Metrics at Camera Traps #slope, TRI, aspect, and TPI values at each of your 71 camera trap locations

slope_data <- terra::extract(slope, camera_traps)
tri_data <- terra::extract(tri, camera_traps)
aspect_data <- terra::extract(aspect, camera_traps)
tpi_data <- terra::extract(tpi, camera_traps)

# Check what we extracted
head(slope_data)
head(tri_data)

# Add to camera_traps vector
camera_traps$slope <- slope_data[,2]
camera_traps$tri <- tri_data[,2]
camera_traps$aspect <- aspect_data[,2]
camera_traps$tpi <- tpi_data[,2]

# Check result - now you should see all terrain variables!
print(camera_traps)

# Summary statistics
summary(camera_traps$slope)
summary(camera_traps$tri)
summary(camera_traps$aspect)
summary(camera_traps$tpi)

# Export updated CSV with all terrain metrics
camera_traps_df <- as.data.frame(camera_traps)
write.csv(camera_traps_df, "camera_traps_with_terrain.csv", row.names=FALSE)

# Calculating distances 

# Distance to Fish River
dist_fish_river <- terra::distance(dem, fish_river_utm)
plot(dist_fish_river, main="Distance to Fish River (m)")
plot(camera_traps, add=TRUE, col='honeydew2', pch=17, cex=0.8)

# Distance to Konkiep River
dist_konkiep_river <- terra::distance(dem, konkiep_river_utm)
plot(dist_konkiep_river, main="Distance to Konkiep River (m)")
plot(camera_traps, add=TRUE, col='honeydew2', pch=17, cex=0.8)

# Distance to water points 
dist_water_points <- terra::distance(dem, water_points_utm)
plot(dist_water_points, main="Distance to Water Points (m)")
plot(camera_traps, add=TRUE, col='honeydew2', pch=17, cex=0.8)

# Distance to tourist road 
dist_tourist_road <- terra::distance(dem, tourist_road_utm)
plot(dist_tourist_road, main="Distance to Tourist Road (m)")
plot(camera_traps, add=TRUE, col='honeydew2', pch=17, cex=0.8)

# Distance to staff buildings
dist_staff_buildings <- terra::distance(dem, staff_buildings_utm)
plot(dist_staff_buildings, main="Distance to Staff Buildings (m)")
plot(camera_traps, add=TRUE, col='honeydew2', pch=17, cex=0.8)

# Extract distance values at camera trap locations
dist_fish_data <- terra::extract(dist_fish_river, camera_traps)
dist_konkiep_data <- terra::extract(dist_konkiep_river, camera_traps)
dist_water_data <- terra::extract(dist_water_points, camera_traps)
dist_road_data <- terra::extract(dist_tourist_road, camera_traps)
dist_buildings_data <- terra::extract(dist_staff_buildings, camera_traps)

# Add to camera_traps vector
camera_traps$dist_fish_river <- dist_fish_data[,2]
camera_traps$dist_konkiep_river <- dist_konkiep_data[,2]
camera_traps$dist_water_points <- dist_water_data[,2]
camera_traps$dist_tourist_road <- dist_road_data[,2]
camera_traps$dist_staff_buildings <- dist_buildings_data[,2]

# Check result 
print(camera_traps)

# Summary statistics for distances
summary(camera_traps$dist_fish_river)
summary(camera_traps$dist_water_points)
summary(camera_traps$dist_tourist_road)

# Export final covariate dataset
camera_traps_df <- as.data.frame(camera_traps)
write.csv(camera_traps_df, "camera_traps_all_covariates.csv", row.names=FALSE)

